{% extends 'base.html' %}
{% load static %}
{% block content %}

<style>
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
    }
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.8; }
    }
    @keyframes shimmer {
        0% { background-position: -1000px 0; }
        100% { background-position: 1000px 0; }
    }
    .fade-in-up { 
        animation: fadeInUp 0.6s ease-out forwards; 
    }
    .lot-card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        opacity: 0;
        animation: fadeInUp 0.6s ease-out forwards;
        position: relative;
        overflow: hidden;
        background: white;
    }
    .lot-card::after {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(236, 72, 153, 0.03), transparent);
        transition: left 0.5s;
    }
    .lot-card:hover::after { left: 100%; }
    .lot-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 24px rgba(236, 72, 153, 0.15);
        border-color: #ec4899;
    }
    .filter-btn {
        transition: all 0.25s ease;
        font-weight: 600;
    }
    .filter-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(236, 72, 153, 0.2);
    }
    .filter-btn.active {
        background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(236, 72, 153, 0.3);
    }
    .search-input {
        transition: all 0.3s ease;
    }
    .search-input:focus {
        box-shadow: 0 8px 20px rgba(236, 72, 153, 0.15);
        border-color: #ec4899;
        transform: translateY(-1px);
    }
    .pulse-animation { animation: pulse 2s infinite; }
    .stat-card {
        transition: all 0.3s ease;
        background: white;
    }
    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 20px rgba(236, 72, 153, 0.15);
    }
    .stat-icon { 
        transition: all 0.3s ease;
    }
    .stat-card:hover .stat-icon {
        transform: scale(1.1) rotate(5deg);
    }
    .info-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.25rem 0.625rem;
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-radius: 9999px;
    }
    .action-btn {
        transition: all 0.2s ease;
    }
    .action-btn:hover {
        transform: scale(1.05);
    }
    .gradient-border::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #ec4899, #f59e0b, #8b5cf6);
        animation: shimmer 3s infinite;
        background-size: 200% 100%;
    }
    .lot-card:nth-child(1) { animation-delay: 0.05s; }
    .lot-card:nth-child(2) { animation-delay: 0.1s; }
    .lot-card:nth-child(3) { animation-delay: 0.15s; }
    .lot-card:nth-child(4) { animation-delay: 0.2s; }
    .lot-card:nth-child(5) { animation-delay: 0.25s; }
    .lot-card:nth-child(6) { animation-delay: 0.3s; }
    .delay-1 { animation-delay: 0.1s; opacity: 0; }
    .delay-2 { animation-delay: 0.2s; opacity: 0; }
    .delay-3 { animation-delay: 0.3s; opacity: 0; }
    .delay-4 { animation-delay: 0.4s; opacity: 0; }
    
    .compact-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.75rem;
        background: #f8fafc;
        border-radius: 0.5rem;
        transition: all 0.2s;
    }
    .compact-info:hover {
        background: #f1f5f9;
        transform: translateX(2px);
    }
    .compact-icon {
        width: 2rem;
        height: 2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.5rem;
        flex-shrink: 0;
    }
    @media (max-width: 640px) {
        .lot-card { margin-bottom: 0.75rem; }
    }
</style>

<div class="bg-gradient-to-br from-slate-50 via-pink-50 to-orange-50 min-h-screen">
<div class="max-w-screen-2xl mx-auto px-4 md:px-6 py-6 md:py-8">
    
    <!-- Page Header -->
    <div class="mb-6 fade-in-up">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
                <h1 class="text-3xl md:text-4xl font-black text-slate-800 mb-1 tracking-tight">
                    <i class="fas fa-box-open text-pink-600 mr-2"></i>Auction Lots
                </h1>
                <p class="text-sm md:text-base text-slate-600 font-medium">
                    Browse <span class="text-pink-600 font-bold">{{ total_count }}</span> lot{{ total_count|pluralize }}
                </p>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4 mb-6">
        <div class="stat-card border border-slate-200 p-4 fade-in-up delay-1 rounded-xl">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs text-slate-500 font-bold uppercase mb-1">Total</p>
                    <p class="text-2xl md:text-3xl font-black text-slate-800">{{ lots.count }}</p>
                </div>
                <div class="stat-icon w-12 h-12 bg-pink-100 flex items-center justify-center rounded-xl">
                    <i class="fas fa-boxes text-pink-600 text-xl"></i>
                </div>
            </div>
        </div>

        <div class="stat-card border border-emerald-200 p-4 fade-in-up delay-2 rounded-xl">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs text-emerald-600 font-bold uppercase mb-1">Active</p>
                    <p class="text-2xl md:text-3xl font-black text-emerald-600">{{ counts.active }}</p>
                </div>
                <div class="stat-icon w-12 h-12 bg-emerald-100 flex items-center justify-center rounded-xl">
                    <i class="fas fa-circle text-emerald-600 text-xl pulse-animation"></i>
                </div>
            </div>
        </div>

        <div class="stat-card border border-blue-200 p-4 fade-in-up delay-3 rounded-xl">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs text-blue-600 font-bold uppercase mb-1">Sold</p>
                    <p class="text-2xl md:text-3xl font-black text-blue-600">{{ counts.sold }}</p>
                </div>
                <div class="stat-icon w-12 h-12 bg-blue-100 flex items-center justify-center rounded-xl">
                    <i class="fas fa-check-circle text-blue-600 text-xl"></i>
                </div>
            </div>
        </div>

        <div class="stat-card border border-slate-200 p-4 fade-in-up delay-4 rounded-xl">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs text-slate-500 font-bold uppercase mb-1">Draft</p>
                    <p class="text-2xl md:text-3xl font-black text-slate-800">{{ counts.draft }}</p>
                </div>
                <div class="stat-icon w-12 h-12 bg-slate-100 flex items-center justify-center rounded-xl">
                    <i class="fas fa-file-alt text-slate-600 text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter -->
    <div class="bg-white border border-slate-200 shadow-md mb-6 p-5 md:p-6 fade-in-up gradient-border rounded-xl relative">
        <div class="mb-5">
            <label class="block text-xs font-bold text-slate-700 mb-2 uppercase tracking-wide">
                <i class="fas fa-search mr-1 text-pink-600"></i>Search
            </label>
            <div class="relative">
                <input 
                    type="text" 
                    id="searchInput" 
                    placeholder="Search lots..."
                    class="search-input w-full px-4 py-2.5 border border-slate-300 focus:outline-none focus:border-pink-500 text-sm rounded-lg"
                >
                <i class="fas fa-search absolute right-3 top-3 text-slate-400"></i>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
                <label class="block text-xs font-bold text-slate-700 mb-2 uppercase tracking-wide">
                    <i class="fas fa-filter mr-1 text-pink-600"></i>Status
                </label>
                <div class="flex flex-wrap gap-2">
                    <button class="filter-btn active px-3 py-2 bg-pink-600 text-white font-bold text-xs uppercase rounded-lg" data-filter="all" data-type="status">
                        All
                    </button>
                    <button class="filter-btn px-3 py-2 bg-white border border-slate-300 text-slate-700 font-bold text-xs uppercase rounded-lg" data-filter="active" data-type="status">
                        Active
                    </button>
                    <button class="filter-btn px-3 py-2 bg-white border border-slate-300 text-slate-700 font-bold text-xs uppercase rounded-lg" data-filter="sold" data-type="status">
                        Sold
                    </button>
                    <button class="filter-btn px-3 py-2 bg-white border border-slate-300 text-slate-700 font-bold text-xs uppercase rounded-lg" data-filter="draft" data-type="status">
                        Draft
                    </button>
                    <button class="filter-btn px-3 py-2 bg-white border border-slate-300 text-slate-700 font-bold text-xs uppercase rounded-lg" data-filter="withdrawn" data-type="status">
                        Withdrawn
                    </button>
                </div>
            </div>

            <div>
                <label class="block text-xs font-bold text-slate-700 mb-2 uppercase tracking-wide">
                    <i class="fas fa-gavel mr-1 text-pink-600"></i>Auction
                </label>
                <select id="auctionFilter" class="w-full px-4 py-2.5 border border-slate-300 focus:outline-none focus:border-pink-500 text-sm font-semibold rounded-lg">
                    <option value="all">All Auctions</option>
                    {% for auction in auctions %}
                    <option value="{{ auction.id }}">{{ auction.title }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="pt-4 border-t border-slate-200">
            <p class="text-sm text-slate-600 font-semibold">
                <i class="fas fa-chart-bar text-pink-600 mr-1"></i>
                Showing <span id="resultCount" class="text-pink-600 font-black">{{ total_count }}</span> result(s)
            </p>
        </div>
    </div>

    <!-- Lots Grid -->
    <div id="lotsGrid" class="grid grid-cols-1 lg:grid-cols-2 2xl:grid-cols-3 gap-4">
        {% for lot in lots %}
        <div class="lot-card bg-white border border-slate-200 shadow-sm rounded-xl" 
             data-title="{{ lot.title|lower }}" 
             data-lot-number="{{ lot.lot_number }}"
             data-status="{{ lot.status }}"
             data-auction-id="{{ lot.auction.id }}"
             data-auction-title="{{ lot.auction.title|lower }}">
            
            <!-- Compact Header -->
            <div class="p-4 border-b border-slate-100">
                <div class="flex items-start justify-between gap-2 mb-3">
                    <div class="flex-1 min-w-0">
                        <h3 class="text-lg md:text-xl font-black text-slate-900 hover:text-pink-600 transition leading-tight mb-2 truncate">
                            {{ lot.title }}
                        </h3>
                        <div class="flex flex-wrap items-center gap-1.5 mb-2">
                            <span class="info-badge bg-slate-800 text-white">
                                Lot #{{ lot.lot_number }}
                            </span>
                            <span class="info-badge bg-pink-100 text-pink-700">
                                <i class="fas fa-box text-xs"></i>{{ lot.item_count }} Item
                            </span>
                        </div>
                    </div>
                    <div class="flex-shrink-0">
                        {% if lot.status == 'active' %}
                        <span class="info-badge bg-emerald-500 text-white">
                            <i class="fas fa-circle text-xs pulse-animation"></i>Active
                        </span>
                        {% elif lot.status == 'sold' %}
                        <span class="info-badge bg-blue-500 text-white">
                            <i class="fas fa-check-circle text-xs"></i>Sold
                        </span>
                        {% elif lot.status == 'draft' %}
                        <span class="info-badge bg-slate-400 text-white">
                            <i class="fas fa-file-alt text-xs"></i>Draft
                        </span>
                        {% elif lot.status == 'unsold' %}
                        <span class="info-badge bg-amber-500 text-white">
                            <i class="fas fa-times-circle text-xs"></i>Unsold
                        </span>
                        {% elif lot.status == 'withdrawn' %}
                        <span class="info-badge bg-red-500 text-white">
                            <i class="fas fa-ban text-xs"></i>Withdrawn
                        </span>
                        {% endif %}
                    </div>
                </div>

                <p class="text-xs text-slate-500 line-clamp-2 mb-2">
                    {{ lot.description|truncatewords:15 }}
                </p>

                <!-- Auction Badge -->
                <div class="inline-flex items-center gap-1.5 px-2.5 py-1.5 bg-gradient-to-r from-pink-50 to-orange-50 border border-pink-200 rounded-full">
                    <i class="fas fa-gavel text-pink-600 text-xs"></i>
                    <span class="text-xs font-bold text-pink-800">{{ lot.auction.title|truncatewords:3 }}</span>
                </div>
            </div>

            <!-- Compact Info Grid -->
            <div class="p-4 bg-slate-50 space-y-2">
                <!-- Key Metrics Row -->
                <div class="grid grid-cols-2 gap-2">
                    <div class="compact-info">
                        <div class="compact-icon bg-pink-100">
                            <i class="fas fa-tag text-pink-600 text-sm"></i>
                        </div>
                        <div>
                            <p class="text-xs text-slate-500 font-bold uppercase">Start</p>
                            <p class="text-base font-black text-pink-600">₹{{ lot.starting_bid|floatformat:0 }}</p>
                        </div>
                    </div>

                    <div class="compact-info">
                        <div class="compact-icon bg-blue-100">
                            <i class="fas fa-calculator text-blue-600 text-sm"></i>
                        </div>
                        <div>
                            <p class="text-xs text-slate-500 font-bold uppercase">Est.</p>
                            <p class="text-base font-black text-blue-600">₹{{ lot.estimated_total_value|floatformat:0 }}</p>
                        </div>
                    </div>
                </div>

                {% if lot.reserve_price or lot.current_bid > 0 %}
                <div class="grid grid-cols-2 gap-2">
                    {% if lot.reserve_price %}
                    <div class="compact-info">
                        <div class="compact-icon bg-amber-100">
                            <i class="fas fa-shield-alt text-amber-600 text-xs"></i>
                        </div>
                        <div>
                            <p class="text-xs text-slate-500 font-bold">Reserve</p>
                            <p class="text-sm font-black text-amber-600">₹{{ lot.reserve_price|floatformat:0 }}</p>
                        </div>
                    </div>
                    {% endif %}

                    {% if lot.current_bid > 0 %}
                    <div class="compact-info">
                        <div class="compact-icon bg-emerald-100">
                            <i class="fas fa-chart-line text-emerald-600 text-xs"></i>
                        </div>
                        <div>
                            <p class="text-xs text-slate-500 font-bold">Current</p>
                            <p class="text-sm font-black text-emerald-600">₹{{ lot.current_bid|floatformat:0 }}</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                {% if lot.winning_bidder %}
                <div class="compact-info bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200">
                    <div class="compact-icon bg-gradient-to-br from-green-600 to-emerald-600">
                        <i class="fas fa-trophy text-white text-sm"></i>
                    </div>
                    <div>
                        <p class="text-xs text-slate-500 font-bold uppercase">Winner</p>
                        <p class="text-xs font-bold text-green-700">{{ lot.winning_bidder.get_full_name|default:lot.winning_bidder.username|truncatechars:15 }}</p>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Compact Footer -->
            <div class="p-3 bg-white border-t border-slate-100 flex gap-2">
                <a href="{% url 'lot_detail' lot.id %}" class="action-btn flex-1 text-center px-3 py-2 bg-gradient-to-r from-pink-600 to-pink-700 text-white font-bold uppercase text-xs rounded-lg hover:shadow-md">
                    <i class="fas fa-eye mr-1"></i>View
                </a>
                {% if user.is_staff %}
                <a href="" class="action-btn px-3 py-2 bg-slate-100 border border-slate-300 text-slate-700 hover:bg-slate-200 rounded-lg text-xs">
                    <i class="fas fa-edit"></i>
                </a>
                {% if lot.status not in 'sold' %}
                <button onclick="deleteLot('{{ lot.id }}')" class="action-btn px-3 py-2 bg-red-100 border border-red-300 text-red-700 hover:bg-red-200 rounded-lg text-xs">
                    <i class="fas fa-trash"></i>
                </button>
                {% endif %}
                {% endif %}
            </div>
        </div>
        {% empty %}
        <div class="col-span-full text-center py-12 bg-white border border-slate-200 rounded-xl">
            <i class="fas fa-box-open text-slate-300 text-5xl mb-4"></i>
            <h3 class="text-xl font-black text-slate-700 mb-2">No Lots Available</h3>
            <p class="text-slate-500 mb-4 text-sm">Be the first to create a lot</p>
            {% if user.is_staff %}
            <a href="" class="inline-block px-6 py-2.5 bg-pink-600 text-white font-bold hover:bg-pink-700 text-sm uppercase rounded-lg">
                <i class="fas fa-plus-circle mr-1.5"></i>Create Lot
            </a>
            {% endif %}
        </div>
        {% endfor %}
    </div>

    <!-- No Results -->
    <div id="noResults" class="hidden text-center py-12 bg-white border border-slate-200 rounded-xl mt-4">
        <i class="fas fa-search text-slate-300 text-5xl mb-4"></i>
        <h3 class="text-xl font-black text-slate-700 mb-2">No Matching Lots</h3>
        <p class="text-slate-500 mb-4 text-sm">Try adjusting your filters</p>
        <button onclick="resetFilters()" class="px-5 py-2.5 bg-pink-600 text-white font-bold hover:bg-pink-700 rounded-lg text-sm">
            <i class="fas fa-redo mr-1.5"></i>Reset
        </button>
    </div>
</div>
</div>

<script>
    const searchInput = document.getElementById('searchInput');
    const filterButtons = document.querySelectorAll('.filter-btn[data-type="status"]');
    const auctionFilter = document.getElementById('auctionFilter');
    const lotCards = document.querySelectorAll('.lot-card');
    const resultCount = document.getElementById('resultCount');
    const noResults = document.getElementById('noResults');
    const lotsGrid = document.getElementById('lotsGrid');

    let currentStatusFilter = 'all';
    let currentAuctionFilter = 'all';
    let currentSearch = '';

    // Search functionality
    searchInput.addEventListener('input', (e) => {
        currentSearch = e.target.value.toLowerCase().trim();
        filterLots();
    });

    // Status filter functionality
    filterButtons.forEach(button => {
        button.addEventListener('click', () => {
            filterButtons.forEach(btn => {
                btn.classList.remove('active', 'bg-pink-600', 'text-white');
                btn.classList.add('bg-white', 'border', 'border-slate-300', 'text-slate-700');
            });
            
            button.classList.add('active', 'bg-pink-600', 'text-white');
            button.classList.remove('bg-white', 'border', 'border-slate-300');
            
            currentStatusFilter = button.dataset.filter;
            filterLots();
        });
    });

    // Auction filter functionality
    auctionFilter.addEventListener('change', (e) => {
        currentAuctionFilter = e.target.value;
        filterLots();
    });

    // Filter lots based on search and filters
    function filterLots() {
        let visibleCount = 0;

        lotCards.forEach(card => {
            const title = card.dataset.title;
            const lotNumber = card.dataset.lotNumber;
            const status = card.dataset.status;
            const auctionId = card.dataset.auctionId;
            const auctionTitle = card.dataset.auctionTitle;

            const matchesSearch = currentSearch === '' || 
                title.includes(currentSearch) || 
                lotNumber.includes(currentSearch) ||
                auctionTitle.includes(currentSearch);

            const matchesStatusFilter = currentStatusFilter === 'all' || status === currentStatusFilter;
            const matchesAuctionFilter = currentAuctionFilter === 'all' || auctionId === currentAuctionFilter;

            if (matchesSearch && matchesStatusFilter && matchesAuctionFilter) {
                card.style.display = 'block';
                setTimeout(() => card.style.opacity = '1', 50);
                visibleCount++;
            } else {
                card.style.opacity = '0';
                setTimeout(() => card.style.display = 'none', 300);
            }
        });

        resultCount.textContent = visibleCount;

        if (visibleCount === 0) {
            lotsGrid.classList.add('hidden');
            noResults.classList.remove('hidden');
        } else {
            lotsGrid.classList.remove('hidden');
            noResults.classList.add('hidden');
        }
    }

    // Reset filters
    function resetFilters() {
        searchInput.value = '';
        currentSearch = '';
        currentStatusFilter = 'all';
        currentAuctionFilter = 'all';
        
        auctionFilter.value = 'all';
        
        filterButtons.forEach(btn => {
            btn.classList.remove('active', 'bg-pink-600', 'text-white');
            btn.classList.add('bg-white', 'border', 'border-slate-300', 'text-slate-700');
        });
        
        const allButton = document.querySelector('[data-filter="all"]');
        if (allButton) {
            allButton.classList.add('active', 'bg-pink-600', 'text-white');
            allButton.classList.remove('bg-white', 'border', 'border-slate-300');
        }
        
        filterLots();
    }

    // Delete lot function
    function deleteLot(lotId) {
        if (!confirm('Are you sure you want to delete this lot? All items will be returned to available status.')) {
            return;
        }

        fetch(`/lots/${lotId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to delete lot: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            alert('Error deleting lot');
            console.error(error);
        });
    }

    // Get CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
        filterLots();
    });
</script>

{% endblock %}