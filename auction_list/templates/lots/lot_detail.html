{% extends 'base.html' %}
{% load static %}

{% block title %}Lot Details | {{ lot.title }}{% endblock %}

{% block content %}
<div class="max-w-screen-2xl mx-auto px-4 md:px-6 py-12">
    <!-- Main Lot Detail Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 reveal-fade">
        <!-- Left: Items Grid Section (Updated) -->
        <div class="lg:col-span-1 space-y-6">
            <h3 class="text-xl font-black uppercase text-slate-900 border-l-4 border-purple-600 pl-3">Items in Lot</h3>

            <div class="grid grid-cols-2 gap-4">
                {% for item in lot.items.all %}
                <a href="{% url 'item_detail' item.id item.slug %}"
                    class="group bg-white border-2 border-slate-200 hover:border-purple-600 transition-colors p-2 pt-0">
                    <div class="aspect-square bg-slate-100 overflow-hidden mb-2 relative">
                        {% if item.images %}
                        <img src="/media/{{ item.images.0 }}" alt="{{ item.title }}"
                            class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500">
                        {% else %}
                        <div class="flex items-center justify-center h-full text-slate-300">
                            <i class="fas fa-image text-4xl"></i>
                        </div>
                        {% endif %}
                        <div class="absolute inset-0 bg-black/0 group-hover:bg-black/5 transition-colors"></div>
                    </div>
                    <div class="px-1">
                        <p class="text-xs font-bold text-slate-800 truncate">{{ item.title }}</p>
                        <p class="text-[10px] text-slate-500">Est: ₹{{ item.estimated_value }}</p>
                    </div>
                </a>
                {% empty %}
                <div
                    class="col-span-2 p-4 text-center text-slate-500 bg-slate-50 border border-slate-200 border-dashed rounded">
                    <i class="fas fa-box-open text-2xl mb-2"></i>
                    <p class="text-xs">No individual items listed.</p>
                </div>
                {% endfor %}
            </div>

            <!-- Lot Info -->
            <div class="bg-white border-2 border-slate-900 p-6">
                <h1 class="text-2xl font-black text-slate-900 uppercase tracking-tighter mb-4 italic">{{ lot.title }}
                </h1>
                <p class="text-slate-500 text-sm leading-relaxed mb-4">
                    {{ lot.description|default:"No description available for this lot." }}</p>

                <div class="space-y-2 text-xs">
                    <div class="flex justify-between py-2 border-b border-slate-100">
                        <span class="text-slate-600 font-semibold">Auction:</span>
                        <span class="text-slate-900 font-bold">{{ lot.auction.title }}</span>
                    </div>
                    <div class="flex justify-between py-2 border-b border-slate-100">
                        <span class="text-slate-600 font-semibold">Category:</span>
                        <span class="text-slate-900 font-bold">{{ lot.lot_catagory.name|default:"Uncategorized"}}</span>
                    </div>
                    <div class="flex justify-between py-2 border-b border-slate-100">
                        <span class="text-slate-600 font-semibold">Status:</span>
                        <span class="px-2 py-1 rounded text-xs font-bold
                            {% if lot.status == 'active' %}bg-green-100 text-green-800
                            {% elif lot.status == 'sold' %}bg-blue-100 text-blue-800
                            {% else %}bg-slate-100 text-slate-800{% endif %}">
                            {{ lot.get_status_display }}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Middle: Bidding Section -->
        <div class="lg:col-span-1 bg-white border-2 border-slate-900 p-6">
            <h2 class="text-xl font-black uppercase mb-6 border-b-2 border-slate-900 pb-3">Place Your Bid</h2>

            <!-- Timer (for timed lots) -->
            {% if lot.is_timed %}
            <div id="timer-section" class="mb-6 p-4 bg-gradient-to-r from-red-500 to-orange-500 text-white rounded-lg">
                <p class="text-xs font-bold uppercase mb-2">Time Remaining</p>
                <div id="timer-display" class="text-3xl font-black font-mono"></div>
            </div>
            {% endif %}

            <!-- Countdown Timer (10 seconds before end) -->
            <div id="countdown-section"
                class="hidden mb-6 p-6 bg-gradient-to-r from-red-600 to-orange-600 text-white rounded-lg border-4 border-yellow-400 shadow-2xl animate-pulse">
                <div class="text-center">
                    <p class="text-sm font-black uppercase mb-2 tracking-widest">⚠️ Auction Ending Soon! ⚠️</p>
                    <div id="countdown-display" class="text-6xl font-black font-mono drop-shadow-lg">00:10</div>
                    <p class="text-xs font-bold uppercase mt-2 tracking-wider">Seconds Remaining</p>
                </div>
            </div>

            <!-- Wallet Balance -->
            <div class="mb-6 p-4 bg-green-50 border-2 border-green-200 rounded-lg">
                <div class="flex justify-between items-center">
                    <span class="text-xs font-bold text-green-700 uppercase">Your Wallet Balance:</span>
                    <span id="wallet-balance"
                        class="text-xl font-black text-green-600">₹{{user.wallet.balance|floatformat:2 }}</span>
                </div>
                <a href="{% url 'add_funds' %}"
                    class="text-xs text-green-600 hover:text-green-700 font-semibold mt-2 inline-block">
                    <i class="fas fa-plus-circle mr-1"></i>Add Funds
                </a>
            </div>

            <!-- Current Bid Info -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="p-4 bg-slate-50 border border-slate-200">
                    <p class="text-[10px] uppercase tracking-widest font-black text-slate-400 mb-1">Starting Bid</p>
                    <p class="text-lg font-bold text-slate-500 italic">₹{{ lot.starting_bid|floatformat:2 }}</p>
                </div>
                <div class="p-4 bg-slate-900 border border-slate-900">
                    <p class="text-[10px] uppercase tracking-widest font-black text-slate-400 mb-1">Current Bid</p>
                    <p id="current-bid" class="text-xl font-black text-white italic">₹{{ lot.current_bid|floatformat:2}}
                    </p>
                </div>
            </div>

            <!-- Minimum Increment Display -->
            <div class="mb-4 p-3 bg-purple-50 border border-purple-200 rounded">
                <div class="flex justify-between items-center text-xs">
                    <span class="font-bold text-purple-700">Minimum Increment:</span>
                    <span id="increment-display"
                        class="text-lg font-black text-purple-600">₹{{lot.get_current_increment|floatformat:2}}</span>
                </div>
            </div>

            <!-- Bid Button Form -->
            <div id="bid-form" class="space-y-4">
                <div class="bg-gradient-to-r from-purple-50 to-blue-50 border-2 border-purple-300 p-4 rounded-lg mb-4">
                    <p class="text-[10px] font-black uppercase text-purple-700 tracking-widest mb-2 text-center">Next
                        Bid Amount</p>
                    <p id="next-bid-display" class="text-3xl font-black text-purple-900 text-center">
                        ₹{{lot.get_minimum_bid|floatformat:2 }}</p>
                </div>

                <button id="place-bid-btn"
                    class="w-full px-8 py-6 bg-gradient-to-r from-purple-600 to-blue-600 text-white font-black text-2xl uppercase tracking-widest hover:from-purple-700 hover:to-blue-700 transition-all transform hover:scale-105 disabled:bg-slate-400 disabled:cursor-not-allowed disabled:transform-none shadow-lg">
                    <i class="fas fa-plus-circle mr-3"></i>Place Bid
                </button>

                <p id="bid-error" class="text-red-600 text-xs font-bold hidden"></p>
                <p id="bid-success" class="text-green-600 text-xs font-bold hidden"></p>
            </div>

            <!-- Bid Stats -->
            <div class="mt-6 pt-6 border-t-2 border-slate-100 flex justify-between text-xs">
                <span class="text-slate-600 font-semibold">Total Bids:</span>
                <span id="bid-count" class="font-black text-slate-900 bid-count-display">{{ lot.bids.count }}</span>
            </div>
        </div>

        <!-- Right: Bid History Chat -->
        <div class="lg:col-span-1 bg-white border-2 border-slate-900 flex flex-col" style="max-height: 800px;">
            <div class="bg-slate-900 px-6 py-4">
                <h3 class="text-lg font-black uppercase text-white tracking-widest">
                    <i class="fas fa-comments mr-2"></i>Live Bid Feed
                </h3>
            </div>

            <!-- Bid History Container -->
            <div id="bid-history" class="flex-1 overflow-y-auto p-4 space-y-2 bg-slate-50">
                {% for bid in lot.recent_bids %}
                {% if bid.user == request.user %}
                <div
                    class="bid-item p-3 bg-indigo-50 border border-indigo-200 rounded ml-8 {% if bid.is_winning %}border-l-4 border-l-green-500{% endif %}">
                    <div class="flex justify-between items-start mb-1">
                        <span class="font-bold text-indigo-900 text-sm">
                            <i class="fas fa-gavel text-indigo-600 mr-1"></i> {{ bid.user.username }} (You)
                        </span>
                        {% if bid.is_winning %}
                        <span
                            class="bg-green-500 text-white text-[9px] px-2 py-0.5 rounded-full font-bold">WINNING</span>
                        {% endif %}
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-lg font-black text-indigo-900">₹{{ bid.amount|floatformat:2 }}</span>
                        <span class="text-[9px] text-slate-400 font-mono">{{ bid.timestamp|date:"H:i:s" }}</span>
                    </div>
                </div>
                {% else %}
                <div
                    class="bid-item p-3 bg-white border border-slate-200 rounded mr-8 {% if bid.is_winning %}border-l-4 border-l-green-500{% endif %}">
                    <div class="flex justify-between items-start mb-1">
                        <span class="font-bold text-slate-900 text-sm">{{ bid.user.username }}</span>
                        {% if bid.is_winning %}
                        <span
                            class="bg-green-500 text-white text-[9px] px-2 py-0.5 rounded-full font-bold">WINNING</span>
                        {% endif %}
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-lg font-black text-purple-600">₹{{ bid.amount|floatformat:2 }}</span>
                        <span class="text-[9px] text-slate-400 font-mono">{{ bid.timestamp|date:"H:i:s" }}</span>
                    </div>
                </div>
                {% endif %}
                {% empty %}
                <div class="text-center py-12 text-slate-400">
                    <i class="fas fa-gavel text-4xl mb-3"></i>
                    <p class="text-sm">No bids yet. Be the first!</p>
                </div>
                {% endfor %}
            </div>

            <!-- Connection Status -->
            <div id="connection-status"
                class="px-4 py-2 bg-slate-100 border-t border-slate-200 text-xs flex justify-between items-center">
                <span class="flex items-center">
                    <span class="w-2 h-2 rounded-full bg-green-500 mr-2 animate-pulse"></span>
                    <span class="text-green-700 font-bold">LIVE</span>
                </span>
                <span class="text-slate-400">WebSocket</span>
            </div>

            <!-- Chat Input -->
            <div class="p-3 bg-white border-t-2 border-slate-200">
                <div class="flex gap-2">
                    <input type="text" id="chat-input" placeholder="Type a message..."
                        class="flex-1 px-3 py-2 border border-slate-300 rounded text-sm focus:outline-none focus:border-slate-900">
                    <button id="send-chat-btn"
                        class="px-4 py-2 bg-slate-900 text-white text-xs font-bold uppercase rounded hover:bg-slate-800 transition-colors">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}


<!-- Winner Overlay -->
<div id="winner-overlay"
    class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-md">
    <div class="text-center transform scale-0" id="winner-card">
        <i class="fas fa-trophy text-yellow-400 text-8xl mb-6 drop-shadow-[0_0_30px_rgba(250,204,21,0.6)]"></i>
        <h2 class="text-6xl font-black text-white uppercase tracking-tighter mb-2">SOLD!</h2>
        <p class="text-xl text-slate-300 mb-8">Auction Completed</p>

        <div class="bg-white/10 p-8 rounded-xl border border-white/20 backdrop-blur-lg">
            <p class="text-sm font-bold text-yellow-400 uppercase tracking-widest mb-2">Winner</p>
            <div id="winner-name" class="text-4xl font-black text-white mb-4">username</div>
            <div class="h-px bg-white/20 w-full mb-4"></div>
            <p class="text-sm font-bold text-slate-400 uppercase tracking-widest mb-1">Winning Bid</p>
            <div id="winner-price" class="text-5xl font-black text-green-400">₹0.00</div>
        </div>

        <button onclick="document.getElementById('winner-overlay').classList.add('hidden')"
            class="mt-8 px-8 py-3 bg-white text-slate-900 font-bold uppercase hover:bg-slate-200 transition-colors">
            Close
        </button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Animate page load
        gsap.from(".reveal-fade", {
            duration: 0.8,
            y: 40,
            opacity: 0,
            ease: "power2.out"
        });

        // Config
        const lotId = "{{ lot.id }}";
        const currentUsername = "{{ request.user.username }}";
        const endpoints = {
            placeBid: `/auctions/lot/${lotId}/place-bid/`,
            getUpdates: `/bids/lot/${lotId}/updates/` // Changed to new polling endpoint
        };

        // DOM Elements
        const bidHistoryEl = document.getElementById('bid-history');
        const bidButton = document.getElementById('place-bid-btn');
        const bidErrorEl = document.getElementById('bid-error');
        const bidSuccessEl = document.getElementById('bid-success');
        const currentBidEl = document.getElementById('current-bid');
        const incrementEl = document.getElementById('increment-display');
        const nextBidDisplayEl = document.getElementById('next-bid-display');
        const bidCountEl = document.getElementById('bid-count');
        const countdownSection = document.getElementById('countdown-section');
        const countdownDisplay = document.getElementById('countdown-display');
        const mainTimerDisplay = document.getElementById('timer-display');
        const connectionStatusEl = document.getElementById('connection-status');

        const winnerOverlay = document.getElementById('winner-overlay');
        const winnerNameEl = document.getElementById('winner-name');
        const winnerPriceEl = document.getElementById('winner-price');

        let isSubmitting = false;
        let knownBids = new Set(); // To track seen bids (by timestamp + user + amount)
        let hasShownWinner = false; // Prevent popup loop

        // Initialize known bids from server-rendered template
        {% for bid in lot.recent_bids %}
        // Match the key format used in polling: user_amount(floored)
        knownBids.add("{{ bid.user.username|escapejs }}_" + Math.floor(Number("{{ bid.amount|stringformat:'f' }}")));
        {% endfor %}


        let pollInterval;

        // --- POLLING LOGIC ---
        function startPolling() {
            // Update connection status UI to show "Live" via Polling
            if (connectionStatusEl) {
                connectionStatusEl.innerHTML = `
                <span class="flex items-center">
                    <span class="w-2 h-2 rounded-full bg-green-500 mr-2 animate-pulse"></span>
                    <span class="text-green-700 font-bold">LIVE (SYNC)</span>
                </span>
                <span class="text-slate-400">Real-time</span>
                `;
            }

            // Poll every 1 second
            if (pollInterval) clearInterval(pollInterval);
            pollInterval = setInterval(fetchUpdates, 1000);
        }

        async function fetchUpdates() {
            try {
                // Add timestamp to prevent caching on mobile devices
                const response = await fetch(`${endpoints.getUpdates}?t=${Date.now()}`);

                if (response.status === 404) {
                    console.error("Lot not found (404). Stopping polling.");
                    if (pollInterval) clearInterval(pollInterval);
                    return;
                }

                if (!response.ok) return; // Skip other errors

                const data = await response.json();
                updateUI(data);

                // Stop polling if ended
                if (data.status === 'sold' || data.status === 'unsold') {
                    if (pollInterval) {
                        clearInterval(pollInterval);
                        console.log("Auction ended. Polling stopped.");
                    }
                }

            } catch (error) {
                console.error("Polling error:", error);
            }
        }

        function updateUI(data) {
            // 1. Update Prices
            if (currentBidEl) currentBidEl.textContent = `₹${data.current_bid.toFixed(2)}`;
            if (nextBidDisplayEl) nextBidDisplayEl.textContent = `₹${data.minimum_bid.toFixed(2)}`;

            const increment = data.minimum_bid - data.current_bid;
            if (incrementEl) incrementEl.textContent = `₹${increment.toFixed(2)}`;

            // 2. Update Counts
            if (bidCountEl) {
                bidCountEl.textContent = data.bid_count;
                document.querySelectorAll('.bid-count-display').forEach(el => el.textContent = data.bid_count);
            }

            // 3. Update Timer
            if (data.time_remaining !== null) {
                // If negative or 0, it means expired
                if (data.time_remaining <= 0 && data.status === 'active') {
                    // Slight buffer/waiting for server to process close
                    if (mainTimerDisplay) mainTimerDisplay.textContent = "CLOSING...";
                } else if (data.status === 'sold' || data.status === 'unsold') {
                    if (mainTimerDisplay) mainTimerDisplay.textContent = "ENDED";
                } else {
                    if (mainTimerDisplay) mainTimerDisplay.textContent = formatTime(data.time_remaining);
                }

                // Countdown logic (last 10s)
                if (data.status === 'active' && data.time_remaining <= 10 && data.time_remaining > 0) {
                    showCountdown(data.time_remaining);
                } else if (countdownSection && !countdownSection.classList.contains('hidden')) {
                    countdownSection.classList.add('hidden');
                }
            }

            // 4. Update Bid Feed
            if (data.bids && data.bids.length > 0) {
                // Determine new bids by checking if we have seen them
                const newBids = data.bids.filter(bid => {
                    // Create a unique key for the bid
                    // Note: Timestamp format from JSON might differ slightly from template, check consistency
                    // Simplify key to avoid timezone string mismatches: User + Amount
                    const key = `${bid.user}_${Math.floor(bid.amount)}`;
                    if (!knownBids.has(key)) {
                        knownBids.add(key);
                        return true;
                    }
                    return false;
                });

                // Prepend ONLY new bids
                // Reverse to add oldest of the new ones first (bottom up) or just iterate
                newBids.reverse().forEach(bid => prependBidToFeed(bid));
            }

            // 5. Check Winner / End State
            if (data.status === 'sold' || data.status === 'unsold') {
                handleAuctionEnded(data);
            }
        }

        // --- PLACE BID ---
        // We use the existing Place Bid API (AJAX)
        // NOT WebSocket
        async function placeBid() {
            if (isSubmitting) return;

            // Get amount from NEXT BID display (which is updated by polling)
            const nextBidText = nextBidDisplayEl.textContent.replace('₹', '').replace(',', '').trim();
            const amount = parseFloat(nextBidText);

            if (!amount || isNaN(amount)) {
                showError('Invalid bid amount');
                return;
            }

            isSubmitting = true;
            bidButton.disabled = true;
            bidButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-3"></i>PLACING...';

            try {
                // Use the API view from bids/views.py: place_bid_api
                // We need to construct form data or JSON
                const formData = new FormData();
                formData.append('amount', amount);
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                const response = await fetch(`/bids/place-bid/${lotId}/`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showSuccess('Bid placed successfully!');

                    // Update wallet balance immediately
                    if (result.wallet_balance !== undefined) {
                        const walletBalanceEl = document.getElementById('wallet-balance');
                        if (walletBalanceEl) {
                            walletBalanceEl.textContent = '₹' + result.wallet_balance.toFixed(2);
                        }
                    }

                    // Immediate manual fetch to update UI quickly
                    fetchUpdates();
                } else {
                    showError(result.error || 'Failed to place bid');
                }

            } catch (error) {
                showError('Network error. Please try again.');
                console.error(error);
            } finally {
                isSubmitting = false;

                // Check if auction is ended (only if timer exists and says ENDED)
                const isEnded = mainTimerDisplay && mainTimerDisplay.textContent.trim() === "ENDED";

                // Re-enable if NOT ended
                if (!isEnded) {
                    bidButton.disabled = false;
                    bidButton.innerHTML = '<i class="fas fa-plus-circle mr-3"></i>PLACE BID';
                }
            }
        }

        bidButton.addEventListener('click', placeBid);

        // --- HELPER FUNCTIONS ---

        function formatTime(seconds) {
            if (seconds < 0) return "00:00:00";
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function showCountdown(seconds) {
            if (!countdownSection || !countdownDisplay) return;
            countdownSection.classList.remove('hidden');
            const secs = Math.ceil(seconds);
            countdownDisplay.textContent = secs.toString().padStart(2, '0');

            if (secs <= 3) {
                countdownSection.classList.add('animate-bounce');
                countdownDisplay.classList.add('text-red-200');
            } else {
                countdownSection.classList.remove('animate-bounce');
                countdownDisplay.classList.remove('text-red-200');
            }
        }

        function handleAuctionEnded(data) {
            // Disable button
            if (bidButton) {
                bidButton.disabled = true;
                bidButton.innerHTML = '<i class="fas fa-check-circle mr-3"></i>AUCTION ENDED';
                bidButton.classList.add('opacity-50', 'cursor-not-allowed');
                bidButton.classList.remove('hover:scale-105', 'transform');
            }

            // Hide countdown
            if (countdownSection) countdownSection.classList.add('hidden');

            // Update Main UI with Winner Info
            if (data.status === 'sold' && data.winner) {
                // Update Current Bid Label
                const currentBidLabel = document.querySelector('#current-bid').previousElementSibling;
                if (currentBidLabel) currentBidLabel.textContent = "Winning Bid";

                // Show winner name nearby if not already shown
                // Find standard location or append
                const currentBidContainer = document.querySelector('#current-bid').parentElement;
                if (currentBidContainer && !currentBidContainer.querySelector('.winner-badge')) {
                    currentBidContainer.insertAdjacentHTML('beforeend', `
                        <div class="winner-badge mt-1 pt-1 border-t border-slate-700">
                            <p class="text-[9px] uppercase tracking-widest font-black text-green-400 mb-0">Winner</p>
                            <p class="text-sm font-bold text-white">${data.winner}</p>
                        </div>
                     `);
                }
            }

            // Show Winner Overlay ONLY if it hasn't been shown yet
            if (!hasShownWinner) {
                if (data.status === 'sold' && data.winner) {
                    winnerNameEl.textContent = data.winner;
                    winnerPriceEl.textContent = `₹${data.winning_bid.toFixed(2)}`;
                    winnerOverlay.classList.remove('hidden');

                    gsap.to('#winner-card', {
                        scale: 1,
                        duration: 0.6,
                        ease: 'back.out(1.7)'
                    });

                    hasShownWinner = true; // Mark as shown
                }
            }
        }


        function prependBidToFeed(bid) {
            // Remove previous winning styling from all
            // Note: In a real-time feed, we might want to keep history styles, 
            // but usually only the top one is "winning"
            const items = bidHistoryEl.querySelectorAll('.bid-item');
            items.forEach(el => {
                el.classList.remove('border-l-4', 'border-l-green-500');
                const label = el.querySelector('.winning-label');
                if (label) label.remove();
            });

            const isCurrentUser = bid.user === currentUsername;

            // Format timestamp (basic logic, better to use library or consistent server format)
            const timeStr = new Date(bid.timestamp).toLocaleTimeString();

            const html = `
                <div class="bid-item p-3 ${isCurrentUser ? 'bg-indigo-50 border-indigo-200 ml-8' : 'bg-white border-slate-200 mr-8'} border rounded reveal-bid border-l-4 border-l-green-500">
                    <div class="flex justify-between items-start mb-1">
                        <span class="font-bold ${isCurrentUser ? 'text-indigo-900' : 'text-slate-900'} text-sm">
                            <i class="fas fa-gavel ${isCurrentUser ? 'text-indigo-600' : 'text-slate-400'} mr-1"></i> ${bid.user} ${isCurrentUser ? '(You)' : ''}
                        </span>
                        <span class="winning-label bg-green-500 text-white text-[9px] px-2 py-0.5 rounded-full font-bold">WINNING</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-lg font-black ${isCurrentUser ? 'text-indigo-900' : 'text-purple-600'}">₹${bid.amount.toFixed(2)}</span>
                        <span class="text-[9px] text-slate-400 font-mono">${timeStr}</span>
                    </div>
                </div>
            `;

            bidHistoryEl.insertAdjacentHTML('afterbegin', html);

            // Animate
            gsap.from(".reveal-bid", {
                x: -20,
                opacity: 0,
                duration: 0.3,
                ease: "power2.out"
            });
        }

        function showError(msg) {
            bidErrorEl.textContent = msg;
            bidErrorEl.classList.remove('hidden');
            bidSuccessEl.classList.add('hidden');
            setTimeout(() => bidErrorEl.classList.add('hidden'), 3000);
        }

        function showSuccess(msg) {
            bidSuccessEl.textContent = msg;
            bidSuccessEl.classList.remove('hidden');
            bidErrorEl.classList.add('hidden');
            setTimeout(() => bidSuccessEl.classList.add('hidden'), 3000);
        }

        // Start polling immediately
        startPolling();
    });
</script>
{% endblock %}